window.log=function(){log.history=log.history||[];log.history.push(arguments);if(this.console){console.log(Array.prototype.slice.call(arguments))}};(function(b){var a=function(e,g){var q=b(e),x=q.append(b('<div id="jfmps-inner-header"><div id="jfmps-breadcrumb"><span id="jfmps-default-crumb">相簿</span><span id="jfmps-crumb-separator">&raquo;</span><span id="jfmps-photos-list-crumb"></span></div><a class="jfmps-meta" id="jfmps-num-selected" href="javascript:void(0);">已選擇(<span id="jfmps-selected-count">0</span>)</a><a class="jfmps-meta" id="jfmps-clear-button" href="javascript:void(0);">清除已選相片</a><a class="jfmps-meta" id="jfmps-photo-next-page" data-mtype="photo" href="javascript:void(0);">下一頁</a><a class="jfmps-meta" id="jfmps-photo-prev-page" data-mtype="photo" href="javascript:void(0);">上一頁</a></div><div id="jfmps-album-covers"></div><div id="jfmps-album-photos"></div><div id="jfmps-selected-container"><h3>已選相片</h3><div id="jfmps-selected-photos"></div></div>')),C=b("#jfmps-album-covers",q),u=b("#jfmps-album-photos",q),F=b("#jfmps-selected-photos",q),t=b("#jfmps-selected-count",q),d=b("#jfmps-photos-list-crumb",q),o=b("#jfmps-crumb-separator",q),m=b("#jfmps-clear-button",q),z=b("#jfmps-photo-next-page",q),h=b("#jfmps-photo-prev-page",q),j="{album_name} [X]",E={photosLimit:24,maxPhotosSelected:10,numAlbumColumns:4,numPhotosColumns:6,imageSubmitButton:b("#jfmps-submit-button"),submitCallback:function(L){alert(L)},noAlbumImagesText:"沒有相片",noAlbumsText:"沒有相簿",selectedImageCallback:null,debug:false},J,D,v=0;E=b.extend(true,E,g||{});var l=function(){if(E.numAlbumColumns<1||E.numPhotosColumns<1){if(E.debug){log("settings.numAlbumColumns & settings.numPhotosColumns must be greater than 0")}return}r();FB.api("/me/albums?limit=96",k);z.bind("click",w).hide();h.bind("click",w).hide()};var k=function(L){if(E.debug){log("FB API Response /me/albums:",L)}if(L.data&&L.data.length>0){var N=L.data,O;J={};D={};d.hide();o.hide();u.hide();E.imageSubmitButton.bind("click",A);m.bind("click",y);for(O=0;O<N.length;O++){var M=(O+1)%E.numAlbumColumns===1||E.numAlbumColumns===1?true:false;if(M){C.append('<div class="image-row" />')}i(N[O])}}else{var P="<h2>"+E.noAlbumsText+"</h2>";q.append(P)}};var i=function(L){var O=b('<div id="fb-albumcover-'+L.id+'" class="jfmps-albumcover" />');O.data("album_id",L.id);var N=b('<div class="jfmps-albumname" />').text(L.name);var M=b('<img width="50" src="https://graph.facebook.com/'+L.id+"/picture?access_token="+FB.getAuthResponse().accessToken+'&amp;type=thumbnail" />');O.append(M);O.append(N);O.bind("click",function(P){I(P,O,L.name)});b("div.image-row",C).last().append(O)};var I=function(O,P,N){var L=P.data("album_id"),M=1;d.empty().html(j.replace("{album_name}",N));if(J[L]===undefined){FB.api("/"+L+"/photos?limit="+E.photosLimit,function(Q){if(E.debug){log("FB API Response /"+L+"/photos:",Q)}J[L]={};J[L][M]=Q;K(L,M);p(L,M)})}else{K(L,M);p(L,M)}};var p=function(O,R){var N=J[O][R].data,P;u.empty();if(N.length>0){for(P=0;P<N.length;P++){var M=(P+1)%E.numPhotosColumns===1?true:false;if(M){u.append('<div class="image-row" />')}var L=b('<div id="fb-albumimage-'+N[P].id+'" class="jfmps-albumimage" />');L.data("image_id",N[P].id);if(D[N[P].id]!==undefined){L.addClass("selected")}var S=b('<img width="75" src="https://graph.facebook.com/'+N[P].id+"/picture?access_token="+FB.getAuthResponse().accessToken+'&amp;type=thumbnail" />');L.append(S);b("div.image-row",u).last().append(L);n(L,N[P].images)}}else{var Q="<h2>"+E.noAlbumImagesText+"</h2>";u.append(Q)}d.bind("click",c).show();o.show();C.hide();u.show()};var n=function(L,N){var M=L.data("image_id");L.bind("click",function(O){if(D[M]===undefined){if(v<E.maxPhotosSelected){D[M]=N;L.addClass("selected");H(L);v+=1;r();E.selectedImageCallback!==null?E.selectedImageCallback():null}}else{L.removeClass("selected");delete D[M];B(L)}f()})};var H=function(N){var P=b("img",N),M=N.data("image_id"),L=b('<li id="selected-'+M+'"/>'),O;if(b("ul",F).length<=0){O=b("<ul/>");F.append(O)}else{O=b("ul",F)}P.clone().appendTo(L);O.append(L);G(L)};var G=function(L){var M=b('<span class="jfmps-selected-unselect"/>').html("[x] 移除");M.hide();L.css("position","relative");M.bind("click",function(O){O.preventDefault();O.stopPropagation();var N=L.attr("id").split("selected-")[1];if(E.debug){log("deleted: "+N)}b("#fb-albumimage-"+N).removeClass("selected");delete D[N];L.remove();v-=1;r()});L.bind("mouseenter",function(N){M.show()});L.bind("mouseleave",function(N){M.hide()});L.append(M)};var B=function(M){var L=M.data("image_id"),N=b("ul",F).eq(0);b("li#selected-"+L,N).remove();v-=1;r()};var c=function(){u.empty().hide();d.unbind("click").hide();o.hide();C.show();h.hide();z.hide()};var s=function(){if(v>0){return JSON.stringify(D)}else{return false}};var A=function(M){if(v>0){var L=s();if(E.debug){log(L)}if(E.submitCallback){E.submitCallback(L)}}};var y=function(){for(var L in D){if(D.hasOwnProperty(L)){delete D[L];b("#fb-albumimage-"+L,q).removeClass("selected");b("li#selected-"+L,q).remove()}}v=0;r();m.hide()};var f=function(){if(v>0){E.imageSubmitButton.show();m.show()}else{E.imageSubmitButton.hide();m.hide()}};var r=function(){t.html(v+" / "+E.maxPhotosSelected);f()};var w=function(){if(b(this).data("mtype")=="album"){console.log(b(this).data("url"));FB.api(b(this).data("url"),k)}else{var N=b(this).data("page"),M=b(this).data("albumId"),L="/"+M+"/photos?limit="+E.photosLimit+"&offset="+(E.photosLimit*(N-1));console.log(L);if(J[M][N]===undefined){FB.api(L,function(O){if(E.debug){log("FB API Response /"+M+"/photos/"+N+":",O)}J[M][N]=O;K(M,N);p(M,N)})}else{K(M,N);p(M,N)}}};var K=function(M,N){var L=J[M][N];if(L.paging&&L.paging.next){z.data("page",N+1).show()}else{z.hide()}if(L.paging&&L.paging.previous){h.data("page",N-1).show()}else{h.hide()}z.data("albumId",M);h.data("albumId",M)};l();return{clearSelectedImages:function(){return y()},getSelectedImages:function(){return s()}}};b.fn.jfmps=function(c){return this.each(function(){var e=b(this),d;if(e.data("jfmps")){return e.data("jfmps")}d=new a(this,c);e.data("jfmps",d);return this})}})(jQuery);